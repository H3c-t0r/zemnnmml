"""Update foreign keys [3de697a0da2e].

Revision ID: 3de697a0da2e
Revises: 5330ba58bf20
Create Date: 2022-11-09 17:05:18.761240

"""
import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision = "3de697a0da2e"
down_revision = "5330ba58bf20"
branch_labels = None
depends_on = None


def upgrade() -> None:
    """Upgrade database schema and/or data, creating a new revision."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("artifacts", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_artifacts_producer_step_id_step_run", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_artifacts_parent_step_id_step_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_artifacts_producer_step_id_step_run",
            "step_run",
            ["producer_step_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_artifacts_parent_step_id_step_run",
            "step_run",
            ["parent_step_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("flavor", schema=None) as batch_op:
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=False
        )
        batch_op.drop_constraint("fk_flavor_user_id_user", type_="foreignkey")
        batch_op.drop_constraint(
            "fk_flavor_project_id_project", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_flavor_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_flavor_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="SET NULL",
        )

    with op.batch_alter_table("pipeline", schema=None) as batch_op:
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=False
        )
        batch_op.drop_constraint("fk_pipeline_user_id_user", type_="foreignkey")
        batch_op.drop_constraint(
            "fk_pipeline_project_id_project", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_pipeline_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="SET NULL",
        )
        batch_op.create_foreign_key(
            "fk_pipeline_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("pipeline_run", schema=None) as batch_op:
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=False
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_stack_id_stack", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_pipeline_id_pipeline", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_user_id_user", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_stack_id_stack",
            "stack",
            ["stack_id"],
            ["id"],
            ondelete="SET NULL",
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_pipeline_id_pipeline",
            "pipeline",
            ["pipeline_id"],
            ["id"],
            ondelete="SET NULL",
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="SET NULL",
        )

    with op.batch_alter_table("role_permission", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_role_permission_role_id_role", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_role_permission_role_id_role",
            "role",
            ["role_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("stack", schema=None) as batch_op:
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=False
        )
        batch_op.drop_constraint(
            "fk_stack_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint("fk_stack_user_id_user", type_="foreignkey")
        batch_op.create_foreign_key(
            "fk_stack_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_stack_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="SET NULL",
        )

    with op.batch_alter_table("stack_component", schema=None) as batch_op:
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=False
        )
        batch_op.drop_constraint(
            "fk_stack_component_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_stack_component_user_id_user", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_stack_component_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_stack_component_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="SET NULL",
        )

    with op.batch_alter_table("stack_composition", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_stack_composition_component_id_stack_component",
            type_="foreignkey",
        )
        batch_op.drop_constraint(
            "fk_stack_composition_stack_id_stack", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_stack_composition_component_id_stack_component",
            "stack_component",
            ["component_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_stack_composition_stack_id_stack",
            "stack",
            ["stack_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("step_run", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_step_run_pipeline_run_id_pipeline_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_step_run_pipeline_run_id_pipeline_run",
            "pipeline_run",
            ["pipeline_run_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("step_run_artifact", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_step_run_artifact_step_id_step_run", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_step_run_artifact_artifact_id_artifacts", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_step_run_artifact_step_id_step_run",
            "step_run",
            ["step_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_step_run_artifact_artifact_id_artifacts",
            "artifacts",
            ["artifact_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("step_run_parents", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_step_run_parents_child_id_step_run", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_step_run_parents_parent_id_step_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_step_run_parents_child_id_step_run",
            "step_run",
            ["child_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_step_run_parents_parent_id_step_run",
            "step_run",
            ["parent_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("team_assignment", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_team_assignment_team_id_team", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_team_assignment_user_id_user", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_team_assignment_team_id_team",
            "team",
            ["team_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_team_assignment_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("team_role_assignment", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_team_role_assignment_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_team_role_assignment_team_id_team", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_team_role_assignment_role_id_role", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_team_role_assignment_team_id_team",
            "team",
            ["team_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_team_role_assignment_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_team_role_assignment_role_id_role",
            "role",
            ["role_id"],
            ["id"],
            ondelete="CASCADE",
        )

    with op.batch_alter_table("user_role_assignment", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_user_role_assignment_role_id_role", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_user_role_assignment_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_user_role_assignment_user_id_user", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_user_role_assignment_role_id_role",
            "role",
            ["role_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_user_role_assignment_project_id_project",
            "project",
            ["project_id"],
            ["id"],
            ondelete="CASCADE",
        )
        batch_op.create_foreign_key(
            "fk_user_role_assignment_user_id_user",
            "user",
            ["user_id"],
            ["id"],
            ondelete="CASCADE",
        )

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade database schema and/or data back to the previous revision."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("user_role_assignment", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_user_role_assignment_user_id_user", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_user_role_assignment_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_user_role_assignment_role_id_role", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_user_role_assignment_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_user_role_assignment_project_id_project",
            "project",
            ["project_id"],
            ["id"],
        )
        batch_op.create_foreign_key(
            "fk_user_role_assignment_role_id_role", "role", ["role_id"], ["id"]
        )

    with op.batch_alter_table("team_role_assignment", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_team_role_assignment_role_id_role", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_team_role_assignment_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_team_role_assignment_team_id_team", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_team_role_assignment_role_id_role", "role", ["role_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_team_role_assignment_team_id_team", "team", ["team_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_team_role_assignment_project_id_project",
            "project",
            ["project_id"],
            ["id"],
        )

    with op.batch_alter_table("team_assignment", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_team_assignment_user_id_user", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_team_assignment_team_id_team", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_team_assignment_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_team_assignment_team_id_team", "team", ["team_id"], ["id"]
        )

    with op.batch_alter_table("step_run_parents", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_step_run_parents_parent_id_step_run", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_step_run_parents_child_id_step_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_step_run_parents_parent_id_step_run",
            "step_run",
            ["parent_id"],
            ["id"],
        )
        batch_op.create_foreign_key(
            "fk_step_run_parents_child_id_step_run",
            "step_run",
            ["child_id"],
            ["id"],
        )

    with op.batch_alter_table("step_run_artifact", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_step_run_artifact_artifact_id_artifacts", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_step_run_artifact_step_id_step_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_step_run_artifact_artifact_id_artifacts",
            "artifacts",
            ["artifact_id"],
            ["id"],
        )
        batch_op.create_foreign_key(
            "fk_step_run_artifact_step_id_step_run",
            "step_run",
            ["step_id"],
            ["id"],
        )

    with op.batch_alter_table("step_run", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_step_run_pipeline_run_id_pipeline_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_step_run_pipeline_run_id_pipeline_run",
            "pipeline_run",
            ["pipeline_run_id"],
            ["id"],
        )

    with op.batch_alter_table("stack_composition", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_stack_composition_stack_id_stack", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_stack_composition_component_id_stack_component",
            type_="foreignkey",
        )
        batch_op.create_foreign_key(
            "fk_stack_composition_stack_id_stack", "stack", ["stack_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_stack_composition_component_id_stack_component",
            "stack_component",
            ["component_id"],
            ["id"],
        )

    with op.batch_alter_table("stack_component", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_stack_component_user_id_user", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_stack_component_project_id_project", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_stack_component_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_stack_component_project_id_project",
            "project",
            ["project_id"],
            ["id"],
        )
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=True
        )

    with op.batch_alter_table("stack", schema=None) as batch_op:
        batch_op.drop_constraint("fk_stack_user_id_user", type_="foreignkey")
        batch_op.drop_constraint(
            "fk_stack_project_id_project", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_stack_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_stack_project_id_project", "project", ["project_id"], ["id"]
        )
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=True
        )

    with op.batch_alter_table("role_permission", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_role_permission_role_id_role", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_role_permission_role_id_role", "role", ["role_id"], ["id"]
        )

    with op.batch_alter_table("pipeline_run", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_pipeline_run_user_id_user", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_pipeline_id_pipeline", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_pipeline_run_stack_id_stack", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_project_id_project",
            "project",
            ["project_id"],
            ["id"],
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_pipeline_id_pipeline",
            "pipeline",
            ["pipeline_id"],
            ["id"],
        )
        batch_op.create_foreign_key(
            "fk_pipeline_run_stack_id_stack", "stack", ["stack_id"], ["id"]
        )
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=True
        )

    with op.batch_alter_table("pipeline", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_pipeline_project_id_project", type_="foreignkey"
        )
        batch_op.drop_constraint("fk_pipeline_user_id_user", type_="foreignkey")
        batch_op.create_foreign_key(
            "fk_pipeline_project_id_project", "project", ["project_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_pipeline_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=True
        )

    with op.batch_alter_table("flavor", schema=None) as batch_op:
        batch_op.drop_constraint("fk_flavor_user_id_user", type_="foreignkey")
        batch_op.drop_constraint(
            "fk_flavor_project_id_project", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_flavor_project_id_project", "project", ["project_id"], ["id"]
        )
        batch_op.create_foreign_key(
            "fk_flavor_user_id_user", "user", ["user_id"], ["id"]
        )
        batch_op.alter_column(
            "project_id", existing_type=sa.CHAR(length=32), nullable=True
        )

    with op.batch_alter_table("artifacts", schema=None) as batch_op:
        batch_op.drop_constraint(
            "fk_artifacts_parent_step_id_step_run", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "fk_artifacts_producer_step_id_step_run", type_="foreignkey"
        )
        batch_op.create_foreign_key(
            "fk_artifacts_parent_step_id_step_run",
            "step_run",
            ["parent_step_id"],
            ["id"],
        )
        batch_op.create_foreign_key(
            "fk_artifacts_producer_step_id_step_run",
            "step_run",
            ["producer_step_id"],
            ["id"],
        )

    # ### end Alembic commands ###
