{{- if or (and .Values.zenml.ingress.enabled .Values.zenml.ingress.tls.enabled .Values.zenml.ingress.tls.generateCerts) (and .Values.grpcMetadata.enabled .Values.grpcMetadata.ingress.enabled .Values.grpcMetadata.ingress.tls.enabled .Values.grpcMetadata.ingress.tls.generateCerts) -}}
{{- $ca := genCA "zenml-ca" 365 -}}

{{- if and .Values.zenml.ingress.enabled .Values.zenml.ingress.tls.enabled .Values.zenml.ingress.tls.generateCerts -}}
{{- $serverCert := genSignedCert .Values.zenml.ingress.host nil (list .Values.zenml.ingress.host) 365 $ca -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.zenml.ingress.tls.secretName }}
  labels:
    {{- include "zenml.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  {{- $prevSecret := (lookup "v1" "Secret" .Release.Namespace .Values.zenml.ingress.tls.secretName) -}}
  {{- if or .Release.IsInstall (not $prevSecret) }}
  tls.crt: {{ $serverCert.Cert | b64enc | quote }}
  tls.key: {{ $serverCert.Key | b64enc | quote }}
  ca.crt: {{ $ca.Cert | b64enc | quote }}
  {{- else }}
  tls.crt: {{ index $prevSecret.data "tls.crt" }}
  tls.key: {{ index $prevSecret.data "tls.key" }}
  ca.crt: {{ index $prevSecret.data "ca.crt" }}
  {{- end }}
{{- end }}

{{- if and .Values.grpcMetadata.enabled .Values.grpcMetadata.ingress.enabled .Values.grpcMetadata.ingress.tls.enabled .Values.grpcMetadata.ingress.tls.generateCerts -}}
{{- $serverCert := genSignedCert .Values.zenml.ingress.host nil (list .Values.grpcMetadata.ingress.host) 365 $ca -}}
{{- $clientCert := genSignedCert "" nil nil 365 $ca -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.grpcMetadata.ingress.tls.secretName }}
  labels:
    {{- include "zenml.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  {{- $prevSecret := (lookup "v1" "Secret" .Release.Namespace .Values.grpcMetadata.ingress.tls.secretName) -}}
  {{- if or .Release.IsInstall (not $prevSecret) }}
  tls.crt: {{ $serverCert.Cert | b64enc | quote }}
  tls.key: {{ $serverCert.Key | b64enc | quote }}
  ca.crt: {{ $ca.Cert | b64enc | quote }}
  {{- else }}
  tls.crt: {{ index $prevSecret.data "tls.crt" }}
  tls.key: {{ index $prevSecret.data "tls.key" }}
  ca.crt: {{ index $prevSecret.data "ca.crt" }}
  {{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.grpcMetadata.ingress.tls.clientSecretName }}
  labels:
    {{- include "zenml.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  {{- $prevSecret := (lookup "v1" "Secret" .Release.Namespace .Values.grpcMetadata.ingress.tls.secretName) -}}
  {{- if or .Release.IsInstall (not $prevSecret) }}
  tls.crt: {{ $serverCert.Cert | b64enc | quote }}
  tls.key: {{ $serverCert.Key | b64enc | quote }}
  ca.crt: {{ $ca.Cert | b64enc | quote }}
  {{- else }}
  tls.crt: {{ index $prevSecret.data "tls.crt" }}
  tls.key: {{ index $prevSecret.data "tls.key" }}
  ca.crt: {{ index $prevSecret.data "ca.crt" }}
  {{- end }}
{{- end -}}
{{- end }}
